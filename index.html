<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¬Šè­‰å¯¦æ™‚åˆ†æç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container { max-width: 1800px; margin: 0 auto; }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .header h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .header p {
      color: #7f8c8d;
      font-size: 14px;
    }
    
    .input-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }
    
    .input-section h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      color: #34495e;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #bdc3c7;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
      min-height: 150px;
      transition: border-color 0.3s;
    }
    
    textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-analyze {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-analyze:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-clear {
      background: #ecf0f1;
      color: #34495e;
    }
    
    .btn-clear:hover {
      background: #bdc3c7;
    }
    
    .btn-copy {
      background: #27ae60;
      color: white;
      font-size: 12px;
    }
    
    .btn-copy:hover {
      background: #229954;
    }
    
    .results-section {
      display: none;
      animation: slideIn 0.5s ease-out;
    }
    
    .results-section.active {
      display: block;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 30px;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .comparison-table th {
      background: #2c3e50;
      color: white;
      padding: 14px;
      text-align: center;
      font-weight: bold;
      font-size: 13px;
    }
    
    .comparison-table td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 13px;
    }
    
    .comparison-table tr:hover {
      background: #f9f9f9;
    }
    
    .comparison-table tr:last-child td {
      border-bottom: none;
    }

    .sortable-header {
      cursor: pointer;
      position: relative;
    }
    .sortable-header::after {
      content: '';
      position: absolute;
      right: 8px;
      top: 50%;
      margin-top: -7px;
      border: 5px solid transparent;
      opacity: 0.3;
    }
    .sortable-header:hover::after {
      opacity: 0.6;
    }
    .sortable-header.sorted-asc::after {
      border-bottom-color: white;
      opacity: 1;
    }
    .sortable-header.sorted-desc::after {
      border-top-color: white;
      opacity: 1;
    }
    
    .warrant-code {
      font-weight: bold;
      color: #2980b9;
      text-align: left;
    }
    
    .warrant-name {
      text-align: left;
      font-size: 12px;
      color: #555;
    }
    
    .score-excellent {
      background: #d4edda;
      color: #155724;
      font-weight: bold;
      border-radius: 4px;
      padding: 4px 8px;
    }
    
    .score-good {
      background: #cfe2ff;
      color: #084298;
      font-weight: bold;
      border-radius: 4px;
      padding: 4px 8px;
    }
    
    .score-warning {
      background: #fff3cd;
      color: #856404;
      font-weight: bold;
      border-radius: 4px;
      padding: 4px 8px;
    }
    
    .score-danger {
      background: #f8d7da;
      color: #721c24;
      font-weight: bold;
      border-radius: 4px;
      padding: 4px 8px;
    }
    
    .up {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .down {
      color: #27ae60;
      font-weight: bold;
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      border-left: 5px solid #3498db;
    }
    
    .card h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .card.excellent {
      border-left-color: #27ae60;
    }
    
    .card.warning {
      border-left-color: #f39c12;
    }
    
    .card.danger {
      border-left-color: #e74c3c;
    }
    
    .metric-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .metric-item {
      background: #ecf0f1;
      padding: 15px;
      border-radius: 6px;
    }
    
    .metric-label {
      color: #7f8c8d;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .metric-value {
      color: #2c3e50;
      font-size: 18px;
      font-weight: bold;
    }
    
    .formula-result {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #3498db;
    }
    
    .formula-title {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .formula-value {
      font-size: 16px;
      font-weight: bold;
      color: #2980b9;
      margin-top: 8px;
    }
    
    .recommendation {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid;
    }
    
    .rec-buy {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    
    .rec-hold {
      background: #cfe2ff;
      border-left-color: #0d6efd;
      color: #084298;
    }
    
    .rec-avoid {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    
    .detail-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    .detail-table th {
      background: #34495e;
      color: white;
      padding: 10px;
      text-align: left;
      font-size: 12px;
    }
    
    .detail-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
    }
    
    .detail-table tr:nth-child(even) {
      background: #f9f9f9;
    }
    
    .ranking {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .rank-item {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      border-top: 4px solid #3498db;
    }
    
    .rank-title {
      color: #7f8c8d;
      font-size: 12px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .rank-value {
      font-size: 24px;
      font-weight: bold;
      color: #2980b9;
    }
    
    .rank-note {
      color: #7f8c8d;
      font-size: 11px;
      margin-top: 10px;
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #dc3545;
    }
    
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid #28a745;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .export-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
    }
    
    .export-buttons button {
      flex: 0 1 auto;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 24px;
      }
      
      .metric-row {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      textarea {
        min-height: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é ­éƒ¨ -->
    <div class="header">
      <h1>âš¡ æ¬Šè­‰å¯¦æ™‚åˆ†æç³»çµ±</h1>
      <p>å°ˆæ¥­æ¬Šè­‰åˆ†æå·¥å…· - å³æ™‚è©•ä¼° | æ™ºèƒ½æ±ºç­– | é¢¨éšªç®¡ç†</p>
    </div>

    <!-- è¼¸å…¥å€åŸŸ -->
    <div class="input-section">
      <h2>ğŸ“Š è¼¸å…¥æ¬Šè­‰è³‡æ–™</h2>
      <p>
  å‰å¾€æŸ¥è©¢ï¼š<a href="https://www.warrantwin.com.tw/eyuanta/Warrant/Search.aspx" target="_blank">å…ƒå¤§æ¬Šè­‰ç¶²</a>
</p>
      <div class="input-group">
        <label>è²¼ä¸Šæ¬Šè­‰è³‡æ–™ï¼ˆæ”¯æŒè¡¨æ ¼ã€é€—è™Ÿåˆ†éš”æˆ–ç©ºæ ¼åˆ†éš”ï¼‰</label>
        <textarea id="dataInput" placeholder="ç¯„ä¾‹ï¼š
068735	ä¸€è©®ç¾¤ç›Š52è³¼01	0.11	-0.03	-21.43	202	154.62	0.0600	78	36.04%åƒ¹å¤–	--	11.47	72.48	10.10
066885	ä¸€è©®å…ƒå¯Œ51è³¼01	0.15	-0.05	-25.00	125	144.09	0.0730	55	31.36%åƒ¹å¤–	--	11.12	83.61	32.50
077418	ä¸€è©®å‡±åŸº51è³¼02	0.14	-0.03	-17.65	1153	129.18	0.0850	48	23.44%åƒ¹å¤–	13.33	8.17	64.66	98.20

æˆ–è¤‡è£½æ•´å€‹è¡¨æ ¼è²¼ä¸Š"></textarea>
      </div>

      <div class="input-group" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
        <input type="checkbox" id="considerLiquidity" checked style="width: 18px; height: 18px; cursor: pointer;">
        <label for="considerLiquidity" style="margin-bottom: 0; font-weight: normal; cursor: pointer;">è€ƒæ…®æµå‹•æ€§ (æˆäº¤é‡)</label>
      </div>

      <div class="button-group">
        <button class="btn-analyze" onclick="analyzeData()">ğŸš€ é–‹å§‹åˆ†æ</button>
        <button class="btn-clear" onclick="clearData()">ğŸ”„ æ¸…ç©º</button>
      </div>
    </div>

    <!-- çµæœå€åŸŸ -->
    <div id="resultsContainer" class="results-section">
      <div id="messageContainer"></div>
      <div id="analysisResults"></div>
    </div>
  </div>

  <script>
    let tableData = [];
    let sortState = { key: 'score', direction: 'desc' };

    // --- æ–°å¢ Supabase åˆå§‹åŒ–ç¨‹å¼ç¢¼ ---
    const SUPABASE_URL = 'https://qqavacfhzlgdtzqhneef.supabase.co'; // æ›¿æ›æˆæ‚¨çš„ URL
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxYXZhY2ZoemxnZHR6cWhuZWVmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjA2MTQ4NSwiZXhwIjoyMDgxNjM3NDg1fQ.2kfj_8VF4XS-NA4N5C9sSnZ9DnKCnaG2_4b4OxQNwR0'; // é‡è¦ï¼šè«‹æ›¿æ›æˆæ‚¨çš„ service_role keyï¼Œå› ç‚º anon key æ²’æœ‰å¯«å…¥æ¬Šé™
    
    let supabaseClient;
    try {
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
      console.log('Supabase client initialized.');
    } catch (error) {
      console.error('Error initializing Supabase:', error);
    }
    // --- çµæŸ ---

    function parseWarrantData(input) {
      const lines = input.trim().split('\n').filter(line => line.trim());
      const warrants = [];

      const isSingleLineFormat = lines.length > 0 && (lines[0].includes('\t') || lines[0].split(/\s+/).length > 5);

      if (isSingleLineFormat) {
        for (const line of lines) {
          let parts = line.split('\t');
          if (parts.length < 10) {
            parts = line.split(/\s+/);
          }
          if (parts.length < 10) {
            parts = line.split(',');
          }

          if (parts.length >= 13) {
            try {
              const warrant = {
                code: parts[0].trim(),
                name: parts[1].trim(),
                price: parseFloat(parts[2]),
                change: parseFloat(parts[3]),
                changePercent: parseFloat(parts[4]),
                volume: parseInt(parts[5]),
                exercisePrice: parseFloat(parts[6]),
                exerciseRatio: parseFloat(parts[7]),
                daysLeft: parseInt(parts[8]),
                priceStatus: parts[9].trim(),
                spreadRatio: parts[10].trim() === '--' ? null : parseFloat(parts[10]),
                leverage: parseFloat(parts[11]),
                impliedVol: parseFloat(parts[12]),
                floatingRatio: parts[13] ? parseFloat(parts[13]) : 0
              };
              warrants.push(warrant);
            } catch (e) {
              console.error('è§£æå–®è¡Œæ ¼å¼å¤±æ•—:', line, e);
            }
          }
        }
      } else {
        const fieldsPerWarrant = 14;
        for (let i = 0; i <= lines.length - fieldsPerWarrant; i += fieldsPerWarrant) {
          const chunk = lines.slice(i, i + fieldsPerWarrant);
          const parts = chunk.map(item => item.trim());
          
          try {
            const warrant = {
              code: parts[0],
              name: parts[1],
              price: parseFloat(parts[2]),
              change: parseFloat(parts[3]),
              changePercent: parseFloat(parts[4]),
              volume: parseInt(parts[5]),
              exercisePrice: parseFloat(parts[6]),
              exerciseRatio: parseFloat(parts[7]),
              daysLeft: parseInt(parts[8]),
              priceStatus: parts[9],
              spreadRatio: parts[10].trim() === '--' ? null : parseFloat(parts[10]),
              leverage: parseFloat(parts[11]),
              impliedVol: parseFloat(parts[12]),
              floatingRatio: parts[13] ? parseFloat(parts[13]) : 0
            };
            warrants.push(warrant);
          } catch (e) {
            console.error('è§£æå¤šè¡Œæ ¼å¼å¤±æ•—:', chunk, e);
          }
        }
      }

      return warrants;
    }

    function calculateMetrics(warrant) {
      const volumeScore = Math.min((warrant.volume / 1000) * 100, 100);
      const ms = (warrant.changePercent * 0.4) + (warrant.leverage * 0.3) + (warrant.impliedVol * 0.2) + (volumeScore * 0.1);
      const vr = (warrant.leverage / warrant.impliedVol) * (100 / (warrant.spreadRatio || 5)) * (warrant.daysLeft / 30);
      const tr = (warrant.impliedVol * 2) / (warrant.daysLeft + 1) + ((warrant.spreadRatio || 5) * 0.5);
      const pt = warrant.price * (1 + warrant.changePercent * warrant.leverage * 0.007 - tr * 0.01);
      const sl = warrant.price * (1 - ((warrant.spreadRatio || 5) * 2 + 2.5 + warrant.impliedVol / warrant.daysLeft) / 100) * 0.95;
      return { ms, vr, tr, pt, sl };
    }

    function calculateLiquidityScore(warrant) {
      let volumeScore = 0;
      if (warrant.volume > 1000) volumeScore = 100;
      else if (warrant.volume >= 100) volumeScore = 50;
      else volumeScore = 10;

      let spreadScore = 50;
      if (warrant.spreadRatio !== null) {
        if (warrant.spreadRatio < 3) spreadScore = 100;
        else if (warrant.spreadRatio <= 5) spreadScore = 70;
        else spreadScore = 30;
      }

      let floatingRatioScore = 0;
      if (warrant.floatingRatio >= 1 && warrant.floatingRatio <= 90) floatingRatioScore = 100;
      else if (warrant.floatingRatio > 90) floatingRatioScore = 20;
      else if (warrant.floatingRatio < 1) floatingRatioScore = 30;

      const marketMakerScore = (warrant.spreadRatio !== null) ? 100 : 50;
      const ls = (volumeScore * 0.35) + (spreadScore * 0.25) + (floatingRatioScore * 0.25) + (marketMakerScore * 0.15);
      return ls;
    }

    function getQualityScore(warrant, metrics, liquidityScore, considerLiquidity) {
      let score = 0;
      if (considerLiquidity) {
        score += (liquidityScore / 100) * 45;
      }
      if (warrant.impliedVol < 50) score += 20;
      else if (warrant.impliedVol < 70) score += 10;
      if (warrant.daysLeft > 45) score += 15;
      else if (warrant.daysLeft > 30) score += 10;
      if (metrics.vr > 1.5) score += 20;
      else if (metrics.vr > 1.0) score += 10;
      return Math.min(Math.round(score), 100);
    }

    function getRecommendation(warrant, metrics, score, liquidityScore, considerLiquidity) {
      if (considerLiquidity && liquidityScore < 50) {
        return { type: 'avoid', text: 'âŒ ä¸æ¨è–¦', reason: 'ç¶œåˆæµå‹•æ€§è©•åˆ†éä½' };
      }
      if (!warrant.spreadRatio) {
        return { type: 'avoid', text: 'âŒ ä¸æ¨è–¦', reason: 'æ•¸æ“šä¸å®Œæ•´ (è²·è³£åƒ¹å·®ç¼ºå¤±)' };
      }
      if (warrant.impliedVol > 80) {
        return { type: 'avoid', text: 'âŒ è¿´é¿', reason: 'éš±æ³¢æ¥µé«˜ï¼Œæ™‚é–“è¡°æ¸›é¢¨éšªå¤§' };
      }
      if (warrant.changePercent < -20) {
        return { type: 'hold', text: 'â³ è§€æœ›', reason: 'ç•¶æ—¥ä¸‹è·Œéæ·±ï¼Œç­‰å¾…åå½ˆä¿¡è™Ÿ' };
      }
      if (score >= 70) {
        return { type: 'buy', text: 'âœ… è²·å…¥', reason: 'ç¶œåˆè©•åˆ†å„ªç§€ï¼Œå¯è€ƒæ…®é€²å ´' };
      }
      if (score >= 50) {
        return { type: 'hold', text: 'â³ è§€æœ›', reason: 'æ¢ä»¶ä¸€èˆ¬ï¼Œç­‰å¾…æ›´å¥½æ©Ÿæœƒ' };
      }
      return { type: 'avoid', text: 'âŒ è¿´é¿', reason: 'ç¶œåˆè©•åˆ†ä¸ä½³' };
    }

    function formatNumber(num, decimals = 2) {
      if (num === null || num === undefined) return '--';
      return num.toFixed(decimals);
    }

    function getScoreClass(score) {
      if (score >= 80) return 'score-excellent';
      if (score >= 60) return 'score-good';
      if (score >= 40) return 'score-warning';
      return 'score-danger';
    }

    async function analyzeData() {
      const input = document.getElementById('dataInput').value;
      const resultsContainer = document.getElementById('resultsContainer');
      const messageContainer = document.getElementById('messageContainer');
      const analysisResults = document.getElementById('analysisResults');

      messageContainer.innerHTML = '';
      analysisResults.innerHTML = '';
      resultsContainer.classList.remove('active');

      if (!input.trim()) {
        messageContainer.innerHTML = '<div class="error-message">âŒ è«‹è¼¸å…¥æ¬Šè­‰è³‡æ–™</div>';
        resultsContainer.classList.add('active');
        return;
      }

      analysisResults.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨åˆ†æä¸­...</div>';
      resultsContainer.classList.add('active');

      setTimeout(async () => {
        try {
          const warrants = parseWarrantData(input);
          if (warrants.length === 0) {
            messageContainer.innerHTML = '<div class="error-message">âŒ ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼</div>';
            analysisResults.innerHTML = '';
            return;
          }

          messageContainer.innerHTML = `<div class="success-message">âœ… æˆåŠŸè§£æ ${warrants.length} æª”æ¬Šè­‰</div>`;
          
          const considerLiquidity = document.getElementById('considerLiquidity').checked;
          const analysis = warrants.map(w => {
            const metrics = calculateMetrics(w);
            const liquidityScore = calculateLiquidityScore(w);
            const score = getQualityScore(w, metrics, liquidityScore, considerLiquidity);
            const recommendation = getRecommendation(w, metrics, score, liquidityScore, considerLiquidity);
            return { warrant: w, metrics, score, liquidityScore, recommendation };
          });

          // --- æ–°å¢ï¼šå„²å­˜è³‡æ–™åˆ° Supabase ---
          if (supabaseClient) {
            const recordsToInsert = analysis.map(item => ({
              warrant_code: item.warrant.code,
              warrant_name: item.warrant.name,
              score: item.score,
              liquidity_score: item.liquidityScore,
              recommendation: item.recommendation.text,
              raw_data: item.warrant
            }));

            const { data, error } = await supabaseClient
              .from('analysis_records')
              .insert(recordsToInsert)
              .select();

            if (error) {
              console.error('Error saving to Supabase:', error);
              messageContainer.innerHTML += `<div class="error-message">âŒ å„²å­˜åˆ†æçµæœåˆ°é›²ç«¯å¤±æ•—: ${error.message}</div>`;
            } else {
              console.log('Successfully saved to Supabase:', data);
              messageContainer.innerHTML += '<div class="success-message">â˜ï¸ åˆ†æçµæœå·²æˆåŠŸå„²å­˜è‡³é›²ç«¯</div>';
            }
          }
          // --- çµæŸ ---

          tableData = analysis;
          sortState = { key: 'score', direction: 'desc' };
          sortTableData();

          let html = generateComparisonTable(tableData);
          html += generateDetailedAnalysis(tableData);
          html += generateRanking(tableData);
          html += generateSummary(tableData);

          analysisResults.innerHTML = html;
          initTableSorting();
          updateHeaderStyles();

        } catch (error) {
          messageContainer.innerHTML = `<div class="error-message">âŒ åˆ†æå‡ºéŒ¯: ${error.message}</div>`;
          analysisResults.innerHTML = '';
          console.error(error);
        }
      }, 500);
    }

    function getNestedValue(obj, path) {
      return path.split('.').reduce((acc, part) => acc && acc[part], obj);
    }

    function sortTableData() {
      tableData.sort((a, b) => {
        const valA = getNestedValue(a, sortState.key);
        const valB = getNestedValue(b, sortState.key);

        if (valA === null || valA === undefined) return 1;
        if (valB === null || valB === undefined) return -1;
        
        let comparison = 0;
        if (typeof valA === 'string') {
          comparison = valA.localeCompare(valB, 'zh-Hant');
        } else {
          if (valA > valB) comparison = 1;
          else if (valA < valB) comparison = -1;
        }
        
        return sortState.direction === 'desc' ? comparison * -1 : comparison;
      });
    }

    function renderTableBody() {
      const tableBody = document.getElementById('comparisonTableBody');
      if (!tableBody) return;
      let html = '';
      for (const item of tableData) {
        html += generateTableRow(item);
      }
      tableBody.innerHTML = html;
    }

    function updateHeaderStyles() {
      document.querySelectorAll('.sortable-header').forEach(header => {
        header.classList.remove('sorted-asc', 'sorted-desc');
        if (header.dataset.sort === sortState.key) {
          header.classList.add(sortState.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });
    }

    function initTableSorting() {
      const headers = document.querySelectorAll('.sortable-header');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const sortKey = header.dataset.sort;
          if (sortState.key === sortKey) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.key = sortKey;
            sortState.direction = 'desc';
          }
          sortTableData();
          renderTableBody();
          updateHeaderStyles();
        });
      });
    }

    function generateTableRow({ warrant, score, liquidityScore, recommendation }) {
      const changeClass = warrant.changePercent >= 0 ? 'up' : 'down';
      const recClass = recommendation.type === 'buy' ? 'score-excellent' :
                      recommendation.type === 'hold' ? 'score-good' :
                      'score-danger';
      return `
        <tr>
          <td class="warrant-code">${warrant.code}</td>
          <td class="warrant-name">${warrant.name}</td>
          <td>${formatNumber(warrant.price, 2)}</td>
          <td class="${changeClass}">${formatNumber(warrant.changePercent, 2)}%</td>
          <td>${warrant.volume}</td>
          <td>${formatNumber(warrant.impliedVol, 2)}</td>
          <td>${formatNumber(warrant.leverage, 2)}</td>
          <td>${warrant.daysLeft}</td>
          <td><span class="${getScoreClass(liquidityScore)}">${formatNumber(liquidityScore, 0)}</span></td>
          <td><span class="${getScoreClass(score)}">${formatNumber(score, 0)}</span></td>
          <td><span class="${recClass}">${recommendation.text}</span></td>
        </tr>
      `;
    }

    function generateComparisonTable(analysis) {
      let bodyHtml = '';
      for (const item of analysis) {
        bodyHtml += generateTableRow(item);
      }
      return `
        <div class="card">
          <h3>ğŸ“Š å¿«é€Ÿè©•åˆ†å°æ¯”</h3>
          <table class="comparison-table">
            <thead>
              <tr>
                <th class="sortable-header" data-sort="warrant.code">ä»£ç¢¼</th>
                <th class="sortable-header" data-sort="warrant.name">æ¬Šè­‰åç¨±</th>
                <th class="sortable-header" data-sort="warrant.price">æˆäº¤åƒ¹</th>
                <th class="sortable-header" data-sort="warrant.changePercent">æ¼²è·Œå¹…</th>
                <th class="sortable-header" data-sort="warrant.volume">æˆäº¤é‡</th>
                <th class="sortable-header" data-sort="warrant.impliedVol">éš±æ³¢%</th>
                <th class="sortable-header" data-sort="warrant.leverage">å¯¦è³ªæ§“æ¡¿</th>
                <th class="sortable-header" data-sort="warrant.daysLeft">å‰©é¤˜å¤©æ•¸</th>
                <th class="sortable-header" data-sort="liquidityScore">æµå‹•æ€§è©•åˆ†</th>
                <th class="sortable-header" data-sort="score">ç¶œåˆè©•åˆ†</th>
                <th>å»ºè­°</th>
              </tr>
            </thead>
            <tbody id="comparisonTableBody">
              ${bodyHtml}
            </tbody>
          </table>
        </div>
      `;
    }

    function generateDetailedAnalysis(analysis) {
      let html = '';
      for (const { warrant, metrics, score, liquidityScore, recommendation } of analysis) {
        const cardClass = recommendation.type === 'buy' ? 'excellent' : recommendation.type === 'hold' ? 'warning' : 'danger';
        const recClass = recommendation.type === 'buy' ? 'rec-buy' : recommendation.type === 'hold' ? 'rec-hold' : 'rec-avoid';

        html += `
          <div class="card ${cardClass}">
            <h3>${recommendation.text} ${warrant.code} ${warrant.name}</h3>
            <div class="metric-row">
              <div class="metric-item"><div class="metric-label">ç¶œåˆè©•åˆ†</div><div class="metric-value">${formatNumber(score, 0)}</div></div>
              <div class="metric-item"><div class="metric-label">æµå‹•æ€§è©•åˆ†</div><div class="metric-value">${formatNumber(liquidityScore, 0)}</div></div>
              <div class="metric-item"><div class="metric-label">éš±æ³¢%</div><div class="metric-value">${formatNumber(warrant.impliedVol, 2)}%</div></div>
              <div class="metric-item"><div class="metric-label">å¯¦è³ªæ§“æ¡¿</div><div class="metric-value">${formatNumber(warrant.leverage, 2)}å€</div></div>
            </div>

            <table class="detail-table">
              <tr><th>è©•ä¼°é …ç›®</th><th>æ•¸å€¼</th><th>è©•åƒ¹</th><th>èªªæ˜</th></tr>
              <tr>
                <td>æµå‹•æ€§ (æˆäº¤é‡)</td>
                <td>${warrant.volume}å¼µ</td>
                <td>${warrant.volume > 1000 ? '<span class="score-excellent">å„ªç§€</span>' : warrant.volume > 500 ? '<span class="score-good">å°šå¯</span>' : '<span class="score-danger">æ¥µå·®</span>'}</td>
                <td>${warrant.volume > 1000 ? 'æˆäº¤é‡å……è¶³ï¼Œé€²å‡ºå®¹æ˜“' : warrant.volume > 500 ? 'æˆäº¤é‡ä¸€èˆ¬' : 'æˆäº¤é‡ä¸è¶³ï¼Œé€²å‡ºå›°é›£'}</td>
              </tr>
              <tr>
                <td>è²·è³£åƒ¹å·®</td>
                <td>${warrant.spreadRatio ? formatNumber(warrant.spreadRatio, 2) + '%' : '--'}</td>
                <td>${warrant.spreadRatio ? (warrant.spreadRatio < 3 ? '<span class="score-excellent">å„ªç§€</span>' : warrant.spreadRatio < 5 ? '<span class="score-good">å°šå¯</span>' : '<span class="score-warning">åé«˜</span>') : 'ç„¡æ•¸æ“š'}</td>
                <td>${warrant.spreadRatio ? (warrant.spreadRatio < 3 ? 'åƒ¹å·®å°ï¼Œäº¤æ˜“æˆæœ¬ä½' : warrant.spreadRatio < 5 ? 'åƒ¹å·®ä¸­ç­‰' : 'åƒ¹å·®å¤§ï¼Œäº¤æ˜“æˆæœ¬é«˜') : 'ç„¡æ³•åˆ¤æ–·'}</td>
              </tr>
              <tr>
                <td>éš±æ³¢æ°´ä½</td>
                <td>${formatNumber(warrant.impliedVol, 2)}%</td>
                <td>${warrant.impliedVol < 50 ? '<span class="score-excellent">ä½</span>' : warrant.impliedVol < 70 ? '<span class="score-good">ä¸­</span>' : '<span class="score-danger">é«˜</span>'}</td>
                <td>${warrant.impliedVol < 50 ? 'éš±æ³¢ä½ï¼Œæ™‚é–“è¡°æ¸›æ…¢' : warrant.impliedVol < 70 ? 'éš±æ³¢ä¸­ç­‰' : 'éš±æ³¢é«˜ï¼Œæ™‚é–“è¡°æ¸›å¿«'}</td>
              </tr>
              <tr>
                <td>æ§“æ¡¿æ•ˆæ‡‰</td>
                <td>${formatNumber(warrant.leverage, 2)}å€</td>
                <td>${warrant.leverage > 10 ? '<span class="score-warning">é«˜</span>' : warrant.leverage > 5 ? '<span class="score-good">é©ä¸­</span>' : '<span class="score-excellent">ä½</span>'}</td>
                <td>${warrant.leverage > 10 ? 'æ§“æ¡¿é«˜ï¼Œé¢¨éšªå¤§' : warrant.leverage > 5 ? 'æ§“æ¡¿é©ä¸­ï¼Œé¢¨éšªå¯æ§' : 'æ§“æ¡¿ä½ï¼Œé¢¨éšªå°'}</td>
              </tr>
              <tr>
                <td>æ™‚é–“åƒ¹å€¼</td>
                <td>${warrant.daysLeft}å¤©</td>
                <td>${warrant.daysLeft > 60 ? '<span class="score-excellent">å……è¶³</span>' : warrant.daysLeft > 30 ? '<span class="score-good">é©ä¸­</span>' : '<span class="score-warning">ç·Šå¼µ</span>'}</td>
                <td>${warrant.daysLeft > 60 ? 'æ™‚é–“å……è¶³' : warrant.daysLeft > 30 ? 'æ™‚é–“é©ä¸­' : 'æ™‚é–“ç·Šå¼µï¼Œéœ€æ³¨æ„è¡°æ¸›'}</td>
              </tr>
            </table>

            <div class="formula-result">
              <div class="formula-title">ğŸ”¢ å‹•èƒ½å¼·åº¦è©•åˆ† (MS)</div>
              <div class="formula-value">MS = ${formatNumber(metrics.ms, 2)}</div>
            </div>
            <div class="formula-result">
              <div class="formula-title">ğŸ’° åƒ¹å€¼æ€§åƒ¹æ¯” (VR)</div>
              <div class="formula-value">VR = ${formatNumber(metrics.vr, 2)}</div>
            </div>
            <div class="formula-result">
              <div class="formula-title">â° æ™‚é–“è¡°æ¸›é¢¨éšª (TR)</div>
              <div class="formula-value">TR = ${formatNumber(metrics.tr, 2)}</div>
            </div>

            <div class="recommendation ${recClass}">
              <strong>${recommendation.text}</strong><br>
              ${recommendation.reason}
            </div>
          </div>
        `;
      }
      return html;
    }

    function generateRanking(analysis) {
      if (analysis.length < 2) return '';
      const byLiquidity = [...analysis].sort((a, b) => b.liquidityScore - a.liquidityScore);
      const byLeverage = [...analysis].sort((a, b) => b.warrant.leverage - a.warrant.leverage);
      const byImpliedVol = [...analysis].sort((a, b) => a.warrant.impliedVol - b.warrant.impliedVol);
      return `
        <div class="card">
          <h3>ğŸ† æ’åå°æ¯”</h3>
          <div class="ranking">
            <div class="rank-item">
              <div class="rank-title">æµå‹•æ€§è©•åˆ†æ’å</div>
              <div class="rank-value">1ï¸âƒ£ ${byLiquidity[0].warrant.code}</div>
              <div class="rank-note">${formatNumber(byLiquidity[0].liquidityScore, 0)}åˆ†</div>
            </div>
            <div class="rank-item">
              <div class="rank-title">æ§“æ¡¿æ’å</div>
              <div class="rank-value">1ï¸âƒ£ ${byLeverage[0].warrant.code}</div>
              <div class="rank-note">${formatNumber(byLeverage[0].warrant.leverage, 2)}å€</div>
            </div>
            <div class="rank-item">
              <div class="rank-title">éš±æ³¢æ’å</div>
              <div class="rank-value">1ï¸âƒ£ ${byImpliedVol[0].warrant.code}</div>
              <div class="rank-note">${formatNumber(byImpliedVol[0].warrant.impliedVol, 2)}%</div>
            </div>
          </div>
        </div>
      `;
    }

    function generateSummary(analysis) {
      if (analysis.length === 0) return '';
      const best = analysis[0];
      const worst = analysis[analysis.length - 1];
      return `
        <div class="card">
          <h3>ğŸ’¡ ç¶œåˆå»ºè­°</h3>
          <h4 style="color: #27ae60; margin: 15px 0 10px 0;">âœ… å„ªå…ˆé¸æ“‡</h4>
          <p style="line-height: 1.8; color: #555; margin-bottom: 15px;">
            <strong>${best.warrant.code} ${best.warrant.name}</strong><br>
            ç¶œåˆè©•åˆ†: ${formatNumber(best.score, 0)}åˆ† | 
            æµå‹•æ€§è©•åˆ†: ${formatNumber(best.liquidityScore, 0)}åˆ† | 
            æ€§åƒ¹æ¯”: ${formatNumber(best.metrics.vr, 2)}
          </p>
          <h4 style="color: #e74c3c; margin: 15px 0 10px 0;">âŒ æ‡‰é¿å…</h4>
          <p style="line-height: 1.8; color: #555; margin-bottom: 15px;">
            <strong>${worst.warrant.code} ${worst.warrant.name}</strong><br>
            ç¶œåˆè©•åˆ†: ${formatNumber(worst.score, 0)}åˆ† | 
            æµå‹•æ€§è©•åˆ†: ${formatNumber(worst.liquidityScore, 0)}åˆ† | 
            åŸå› : ${worst.recommendation.reason}
          </p>
          <h4 style="color: #2c3e50; margin: 15px 0 10px 0;">âš ï¸ é¢¨éšªæç¤º</h4>
          <ul style="line-height: 2; color: #555; margin-left: 20px;">
            <li>ğŸ”´ å„ªå…ˆé¸æ“‡æˆäº¤é‡>1000å¼µçš„æ¬Šè­‰</li>
            <li>ğŸ”´ è²·è³£åƒ¹å·®<5%ç‚ºäº¤æ˜“å‰æ</li>
            <li>ğŸ”´ çŸ­æœŸæŒå€‰æ§åˆ¶åœ¨1-5å¤©å…§</li>
            <li>ğŸ”´ å–®ç­†è™§æä¸è¶…éå¸³æˆ¶è³‡é‡‘çš„2%</li>
            <li>ğŸ”´ é¿å…åœ¨éš±æ³¢æ¥µç«¯é«˜ä½(>80%)é€²å ´</li>
            <li>ğŸ”´ å‰©é¤˜å¤©æ•¸<15å¤©çš„æ¬Šè­‰è¬¹æ…äº¤æ˜“</li>
          </ul>
        </div>
      `;
    }

    function clearData() {
      document.getElementById('dataInput').value = '';
      document.getElementById('resultsContainer').classList.remove('active');
      document.getElementById('analysisResults').innerHTML = '';
      document.getElementById('messageContainer').innerHTML = '';
      tableData = [];
    }

    window.addEventListener('load', () => {
      console.log('æ¬Šè­‰åˆ†æç³»çµ±å·²å°±ç·’');
    });
  </script>
</body>
</html>
